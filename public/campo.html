<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campo - OPIDAS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles/profile-widget.css">
    <link rel="stylesheet" href="assets/styles/identity-modal.css">
    <link rel="stylesheet" href="assets/styles/base.css">
    <link rel="stylesheet" href="assets/styles/campo.css">
    <link rel="stylesheet" href="assets/styles/loading-screen.css">
	<!-- Preloader CSS -->
    <link rel="stylesheet" href="preloader.css">
</head>
<body>
	<!-- Preloader Container -->
	<div id="preloader" class="preloader">
	    <div class="preloader-content">
	        <video 
	            class="preloader-video" 
	            autoplay 
	            loop 
	            muted 
	            playsinline
	            poster="assets/motiondesigns/teladecarregamento/preloader_poster.jpg"
	        >
	            <source src="assets/motiondesigns/teladecarregamento/preloader_web.webm" type="video/webm">
	            <source src="assets/motiondesigns/teladecarregamento/preloader_webmp4.mp4" type="video/mp4">
	            Seu navegador n√£o suporta o elemento de v√≠deo.
	        </video>
	    </div>
	</div>
    <div class="app-container"> 
        <a href="doutrina.html"> 
            <img class="opidas-logo-center" alt="Opidas logo" src="assets/styles/images/opidaslogoouroboros.png" style="cursor: pointer;"> </a>
        
        <header class="top-bar">
            <div class="user-welcome">
                <img id="user-avatar" alt="Profile photo" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/profile-card.png" />
                <div class="user-welcome-text">
                    <div class="greeting">Bem vindo(a) de volta</div>
                    <div class="username" id="welcome-username">Carregando...</div>
                </div>
            </div>

            <div class="status-bar">
                <div class="rank-icon" id="status-rank-icon-container">
                    <img id="status-rank-icon" alt="Patente" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/patentes/Recruta.png" />
                </div>
                <div class="progress-info">
                    <p class="days" id="progress-days" style="position: static;">07<span>/10 Dias</span></p>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progress-bar-fill"></div>
                    </div>
                </div>
                <button class="icon-button">
                    <img alt="Notifica√ß√£o button" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/notifica%C3%A7%C3%A3obutton.svg" />
                </button>
                <button class="icon-button" id="logout-button">
                    <img alt="Logout" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/darkmode-button.svg" />
                </button>
            </div>
        </header>

        <div class="main-content">
            <aside class="panel sidebar">
                <div class="sidebar-header">
                    <div class="title">
                        <div class="subtitle">Campo contra o(a)</div>
                        <div class="main-title" id="habit-title">Carregando...</div>
                    </div>
                    <img class="settings-icon" alt="Configura√ß√£o do campo" src="assets/styles/images/icones/configcampo.svg" />
                </div>

                <nav class="sidebar-tabs">
                    <button class="tab-button active">Patentes</button>
                    <button class="tab-button">Admin</button>
                </nav>
                
                <ul class="ranks-list" id="ranks-list">
                    <!-- Lista de patentes ser√° renderizada pelo JS -->
                </ul>

                <div class="sidebar-footer">
                    <p class="reset-info" id="reset-info">Chances de reset <span>...</span></p>
                    <button class="reset-button" id="reset-button">Resetar contagem</button>
                </div>
            </aside>
            
            <main class="panel chat-area">
                <header class="chat-header">
                    <img alt="Logo Chat Opidas" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/icones/logochatopidas.svg" style="width: 34px; height: 34px;">
                    <button class="icon-button">
                        <img alt="Membros do grupo" src="assets/styles/images/icones/pessoasdogrupobot√£o.svg">
                    </button>
                    <div class="search-bar">
                        <input type="search" placeholder="Pesquisar">
                        <img class="search-icon" alt="Search" src="assets/styles/images/icones/search-vector.svg">
                    </div>
                    <button class="icon-button">
                        <img alt="Tela cheia" src="assets/styles/images/icones/bot√£ofullscreenchat.svg">
                    </button>
                </header>

                <div class="messages-container" id="messages-container">
                    <!-- Mensagens ser√£o carregadas dinamicamente -->
                </div>

                <div class="chat-input-wrapper">
                    <form class="chat-input" id="chat-form">
                        <div class="input-field-container">
                            <button type="button"><img src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/icones/uploadbutton.svg" alt="Upload"></button>
                            <input type="text" id="chat-input-field" placeholder="Conversar com o campo">
                            <button type="button"><img src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/icones/sendemojibutton.svg" alt="Emoji"></button>
                        </div>
                        <button class="mic-button" type="button">
                            <img alt="Gravar voz" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/icones/voicebutton.svg">
                        </button>
                    </form>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts do Projeto -->
    <script src="/js/lib/logger.js"></script>
    <script src="/js/components/toast.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/lib/supabase-config.js"></script>
    <script src="js/components/loading-screen.js"></script>
    <script src="js/services/auth.js"></script>
    <script src="js/services/user.js"></script>
    <script src="js/services/chat.js"></script>
    <script src="js/app.js"></script>
    <script src="js/components/identity-modal.js"></script>
    <script src="js/components/profile-widget.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- ESTADO DA APLICA√á√ÉO ---
            const state = {
                currentUser: null,
                activeChannel: null,
                allUsers: [], // Cache de usu√°rios para evitar buscas repetidas
                channels: [ // Isso vir√° do Supabase, mas por enquanto √© mockado
                    { id: 'recruta', level: 0, name: 'Recruta', minDays: 0, maxDays: 9, icon: 'assets/styles/images/patentes/Recruta.png' },
                    { id: 'soldado', level: 1, name: 'Soldado', minDays: 10, maxDays: 29, icon: 'assets/styles/images/patentes/Soldado.png' },
                    { id: 'cabo',    level: 2, name: 'Cabo',    minDays: 30, maxDays: 59, icon: 'assets/styles/images/patentes/Cabo.png' },
                    { id: 'sargento',level: 3, name: 'Sargento',minDays: 60, maxDays: 89, icon: 'assets/styles/images/patentes/Sargento.png' },
                    { id: 'marechal',level: 4, name: 'Marechal',minDays: 90, maxDays: 179, icon: 'assets/styles/images/patentes/Marechal.png' },
                    { id: 'tenente', level: 5, name: 'Tenente', minDays: 180, maxDays: 364, icon: 'assets/styles/images/patentes/Tenente.png' },
                    { id: 'capitao', level: 6, name: 'Capit√£o', minDays: 365, maxDays: Infinity, icon: 'assets/styles/images/patentes/Capit√£o.png' }
                ]
            };

            // --- ELEMENTOS DO DOM ---
            const welcomeUsernameEl = document.getElementById('welcome-username');
            const userAvatarEl = document.getElementById('user-avatar');
            const statusRankIconEl = document.getElementById('status-rank-icon');
            const progressDaysEl = document.getElementById('progress-days');
            const progressBarFillEl = document.getElementById('progress-bar-fill');
            const ranksListEl = document.getElementById('ranks-list');
            const resetInfoEl = document.getElementById('reset-info');
            const resetButtonEl = document.getElementById('reset-button');
            const chatInputFieldEl = document.getElementById('chat-input-field');
            const messagesContainerEl = document.getElementById('messages-container');
            const chatFormEl = document.getElementById('chat-form');
            const habitTitleEl = document.getElementById('habit-title');
            const logoutButton = document.getElementById('logout-button');

            // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
            function updateUI() {
                if (!state.currentUser) return;

                // ‚úÖ CORRIGIDO: state.currentUser j√° √© um objeto flat com rankData dentro
                const profile = state.currentUser;
                const rankData = profile.rankData;
                
                if (!rankData) {
                    console.error('‚ùå rankData n√£o encontrado em state.currentUser');
                    return;
                }
                
                // Header
                welcomeUsernameEl.textContent = `${rankData.name} ${profile.last_name}`;
                userAvatarEl.src = profile.avatar_url || 'https://c.animaapp.com/wYjpt5p0/img/profile-photo-5@2x.png';
                statusRankIconEl.src = rankData.icon;
                habitTitleEl.textContent = profile.habit || 'Indefinido';
                
// Barra de Progresso
	                // ‚ö†Ô∏è CORRE√á√ÉO: Garantir que o retention_days seja calculado se for 0 ou nulo, usando a data de cria√ß√£o do usu√°rio (onboarding_data)
	                let currentRetentionDays = profile.retention_days || 0;
	                
	                // Se o retention_days for 0, calcula os dias desde o onboarding para garantir que o contador comece a contar
	                if (currentRetentionDays === 0 && profile.onboarding_data) {
	                    // A fun√ß√£o calculateDaysSinceOnboarding est√° no UserService, mas n√£o est√° exposta globalmente.
	                    // Como o app.js j√° tem a l√≥gica de c√°lculo, vamos confiar que o profile.retention_days est√° correto
	                    // ou que ser√° atualizado pelo RPC process_daily_checkin.
	                    // Para fins de exibi√ß√£o, vamos usar o valor que vem do banco.
	                }
	
		                const rankGoalDays = isFinite(rankData.maxDays) ? rankData.maxDays + 1 : currentRetentionDays;
		                const progressPercentage = Math.min((currentRetentionDays / rankGoalDays) * 100, 100);
		                progressBarFillEl.style.width = `${progressPercentage}%`;
		                progressDaysEl.innerHTML = `${String(currentRetentionDays).padStart(2, '0')}<span>/${String(rankGoalDays).padStart(2, '0')} Dias</span>`;

                // Sidebar (lista de patentes)
                renderRanksList();

                // Footer da Sidebar
                resetInfoEl.innerHTML = `Chances de reset <span>${profile.remaining_resets} restantes</span>`;
                resetButtonEl.disabled = profile.remaining_resets <= 0;
            }

            function renderRanksList() {
                ranksListEl.innerHTML = '';
                const userRankLevel = state.currentUser.rankData.level;

                state.channels.slice().reverse().forEach(channel => {
                    const li = document.createElement('li');
                    li.className = 'rank-item';
                    li.dataset.channelId = channel.id;

                    const isLocked = channel.level > userRankLevel;
                    const isActive = channel.id === state.activeChannel;

                    if (isLocked) li.classList.add('locked');
                    if (isActive) li.classList.add('active-server');

                    li.innerHTML = `
                        <div class="rank-icon"><img alt="${channel.name}" src="${channel.icon}"></div>
                        <div class="rank-details">
                            <div class="rank-name">${channel.name}</div>
                            <div class="rank-days">Dias: ${channel.minDays}${channel.maxDays === Infinity ? '+' : '-' + channel.maxDays}</div>
                        </div>
                        <div class="status-dot"></div>
                        ${isLocked ? '<div class="rank-overlay"></div>' : ''}
                    `;
                    ranksListEl.appendChild(li);
                });
            }
            
            function renderMessage(message, userProfile) {
                // Valida√ß√£o de seguran√ßa
                if (!userProfile) {
                    console.error('‚ùå userProfile √© null ou undefined. Mensagem:', message);
                    console.warn('‚ö†Ô∏è Isso pode indicar um problema com pol√≠ticas RLS no Supabase.');
                    return;
                }
                
                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                
                const userRank = state.channels.find(c => c.id === userProfile.rank) || state.channels[0];
                const displayName = `${userRank.name} ${userProfile.last_name}`;
                const timestamp = new Date(message.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit'});

                messageEl.innerHTML = `
                    <img class="avatar" alt="Avatar" src="${userProfile.avatar_url}">
                    <div class="message-content">
                        <div class="message-header">
                            <div class="username">${displayName}</div>
                            <div class="timestamp">${timestamp}</div>
                        </div>
                        <div class="message-bubble">${message.content}</div>
                    </div>
                `;
                messagesContainerEl.appendChild(messageEl);
                messagesContainerEl.scrollTop = messagesContainerEl.scrollHeight;
            }

            // --- FUN√á√ïES DE L√ìGICA ---
            async function switchChannel(channelId) {
                if (!channelId || channelId === state.activeChannel) return;

                try {
                    state.activeChannel = channelId;
                    messagesContainerEl.innerHTML = '<h3>Carregando mensagens...</h3>';
                    updateUI(); // Atualiza a sele√ß√£o visual

                    console.log(`üîÑ Mudando para o canal: ${channelId}`);

                    // Cancela inscri√ß√£o do canal anterior
                    await window.ChatService.unsubscribeFromChannel();
                    
                    // Busca mensagens antigas do canal
                    const messages = await window.ChatService.getMessages(channelId, 50);
                    
                    // Renderiza mensagens
                    messagesContainerEl.innerHTML = '';
                    if (messages.length === 0) {
                        messagesContainerEl.innerHTML = '<div class="system-message">Seja o primeiro a conversar neste canal.</div>';
                    } else {
                        messages.forEach(msg => {
                            // msg.profiles cont√©m os dados do usu√°rio (retornado pelo join)
                            const userProfile = msg.profiles;
                            renderMessage(msg, userProfile);
                        });
                    }
                    
                    // Inscreve-se no canal para receber novas mensagens em tempo real
                    await window.ChatService.subscribeToChannel(channelId, (message, profile) => {
                        renderMessage(message, profile);
                    });
                    
                    console.log(`‚úÖ Canal ${channelId} carregado com sucesso`);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao trocar de canal:', error);
                    messagesContainerEl.innerHTML = '<div class="system-message">Erro ao carregar mensagens. Tente novamente.</div>';
                }
            }

            async function handleSendMessage(event) {
                event.preventDefault();
                const content = chatInputFieldEl.value.trim();
                
                if (!content) return;
                if (!state.activeChannel) {
                    alert('Nenhum canal selecionado');
                    return;
                }
                
                try {
                    console.log(`üì§ Enviando "${content}" para o canal ${state.activeChannel}`);
                    
                    // Limpa o campo imediatamente para melhor UX
                    chatInputFieldEl.value = '';
                    
                    // Envia mensagem via ChatService
                    await window.ChatService.sendMessage(state.activeChannel, content);
                    
                    console.log('‚úÖ Mensagem enviada com sucesso');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao enviar mensagem:', error);
                    alert('Erro ao enviar mensagem. Tente novamente.');
                    // Restaura o texto se houver erro
                    chatInputFieldEl.value = content;
                }
            }

                document.getElementById('user-avatar').addEventListener('click', () => {
                    window.ProfileWidget.open();
                });
            
            async function handleResetClick() {
                const confirmed = confirm(`Voc√™ tem certeza que quer resetar sua contagem? Isso usar√° uma de suas chances.`);
                if(confirmed) {
                    try {
                        const resetResult = await window.UserService.handleReset();
                        alert(`Contagem resetada com sucesso! Voc√™ tem ${resetResult.remaining_resets} chances restantes.`);
                        // Recarrega os dados do usu√°rio e atualiza a UI
                        // Passamos skipCheckin: true para evitar que o check-in autom√°tico incremente o dia logo ap√≥s o reset
                        state.currentUser = await window.refreshTopBar({ skipCheckin: true });
                        updateUI();
                    } catch (error) {
                        console.error("Erro ao resetar contagem:", error);
                        alert(`Erro ao resetar contagem: ${error.message}`);
                    }
                    console.log("Reset solicitado.");
                    // alert movido para dentro do try/catch para melhor feedback
                    // A UI ser√° atualizada via Supabase Realtime ou recarregando os dados do usu√°rio
                }
            }

	            // --- INICIALIZA√á√ÉO ---
	            async function init() {
	                try {
	                    // Carrega os dados reais do usu√°rio do Supabase
	                    // O loadTopBar agora processa o check-in di√°rio automaticamente
	                    state.currentUser = await window.loadTopBar();
	                    
	                    console.log('‚úÖ Perfil do usu√°rio carregado:', state.currentUser);
	                } catch (error) {
                    // Oculta o preloader mesmo em caso de erro
                    if (typeof hidePreloader === 'function') {
                        hidePreloader();
                    }
                    console.error('‚ùå Erro ao carregar perfil do usu√°rio:', error);
                    // Redireciona para login se houver erro
                    window.location.href = 'index.html';
                    return;
                }

                if (!state.currentUser) {
                    window.location.href = 'index.html'; // Redireciona se n√£o houver dados
                    return;
                }
                
                // Define o canal inicial baseado na patente do usu√°rio
                const initialChannelId = state.currentUser.rank;
                await switchChannel(initialChannelId);

                // Oculta o preloader ap√≥s o carregamento inicial
                if (typeof hidePreloader === 'function') {
                    hidePreloader();
                }

                // Adiciona Event Listeners
                ranksListEl.addEventListener('click', (e) => {
                    const rankItem = e.target.closest('.rank-item');
                    if (rankItem && !rankItem.classList.contains('locked')) {
                        switchChannel(rankItem.dataset.channelId);
                    }
                });

                chatFormEl.addEventListener('submit', handleSendMessage);
                resetButtonEl.addEventListener('click', handleResetClick);
               // logoutButton.addEventListener('click', async () => {
               //     try {
               //         window.signOut();
               //         // O redirecionamento para 'index.html' j√° est√° dentro de signOut()
               //     } catch (error) {
               //         console.error("Erro durante o logout:", error);
               //         alert("Erro ao fazer logout. Tente novamente.");
               //     }
               // });
            }

            init();
        });
    </script>
    <!-- Preloader JS -->
    <script src="preloader.js"></script>
</body>
</html>
