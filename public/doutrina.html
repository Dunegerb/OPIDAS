<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doutrina - OPIDAS</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles/profile-widget.css">
    <link rel="stylesheet" href="assets/styles/identity-modal.css">
    <link rel="stylesheet" href="assets/styles/base.css">
    <!-- Adicionando o CSS do campo para reutilizar o header -->
    <link rel="stylesheet" href="assets/styles/campo.css"> 
    <link rel="stylesheet" href="assets/styles/doutrina.css">
    <link rel="stylesheet" href="assets/styles/loading-screen.css">
</head>
<body>

    <div class="app-container">
        <a href="campo.html"> 
            <img class="opidas-logo-center" alt="Opidas logo" src="assets/styles/images/campologo.svg" style="cursor: pointer;"> 
        </a>

        <header class="top-bar">
            <div class="user-welcome">
                <img id="user-avatar" alt="Profile photo" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/profile-card.png" />
                <div class="user-welcome-text">
                    <div class="greeting">Bem vindo(a) de volta</div>
                    <div class="username" id="welcome-username">Carregando...</div>
                </div>
            </div>

            <div class="status-bar">
                <div class="rank-icon" id="status-rank-icon-container">
                    <img id="status-rank-icon" alt="Patente" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/patentes/Recruta.png" />
                </div>
                <div class="progress-info">
                    <p class="days" id="progress-days">
                        00<span>/00 Dias</span>
                    </p>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progress-bar-fill"></div>
                    </div>
                </div>
                <button class="icon-button">
                    <img alt="Notificação button" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/notifica%C3%A7%C3%A3obutton.svg" />
                </button>
                <button class="icon-button" id="logout-button">
                    <img alt="Logout" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/darkmode-button.svg" />
                </button>
            </div>
        </header>

        <main class="main-content-doutrina">
            <section class="episodes-section">
                <div class="timeline">
                    <div class="timeline-dots">
                        <div class="timeline-dot dot-1"></div>
                        <div class="timeline-dot dot-2"></div>
                        <div class="timeline-dot dot-3"></div>
                        <div class="timeline-dot dot-4"></div>
                    </div>
                </div>
                <div id="episodes-grid" class="episodes-grid">
                    <!-- Episódios são injetados aqui pelo JavaScript -->
                </div>
            </section>
        </main>
    </div>
    
    <!-- Player Overlay -->
    <div id="player-overlay" class="hidden">
        <div id="video-container" class="video-container paused">
            <video id="video-player" playsinline>
                <source src="" type="video/mp4">
                <track label="Português" kind="subtitles" srclang="pt" src="" default>
            </video>

            <div id="player-controls" class="player-controls">
                <header class="top-controls">
                    <h1 class="episode-title" id="player-episode-title">{nome do episódio}</h1>
                    <nav class="top-right-nav" aria-label="Controles do Vídeo">
                        <button id="pip-btn" aria-label="Picture in picture"><img alt="Picture in picture" src="assets/styles/images/player/popup-bottom.svg"></button>
                        <button id="fullscreen-btn" aria-label="Tela Cheia"><img alt="Tela Cheia" src="assets/styles/images/player/fullscreen-bottom.svg"></button>
                        <div class="separator" aria-hidden="true"></div>
                        <button id="close-player-btn" aria-label="Fechar Player"><img alt="Fechar Player" src="assets/styles/images/player/closeplayer-bottom.svg"></button>
                    </nav>
                </header>

                <div class="center-controls">
                    <button id="skip-backward-btn" class="skip-btn" aria-label="Voltar 10 segundos"><img alt="Voltar 10s" src="assets/styles/images/player/Rewind10sec-bottom.svg"></button>
                    <button id="play-pause-btn" aria-label="Play"><img id="play-pause-icon" alt="Play" src="assets/styles/images/player/playbottom.svg"></button>
                    <button id="skip-forward-btn" class="skip-btn" aria-label="Avançar 10 segundos"><img alt="Avançar 10s" src="assets/styles/images/player/Forward10sec-bottom.svg"></button>
                </div>

                <div class="bottom-controls">
                    <div id="progress-bar-container" class="player-progress-bar-container" role="slider" aria-label="Progresso do vídeo">
                        <div id="player-progress-bar-fill" class="progress-bar-fill"></div>
                    </div>
                    <div class="time-controls">
                        <div class="time-display">
                            <time id="current-time">00:00</time>
                            <span id="duration"> / 00:00</span>
                        </div>
                        <div class="bottom-right-nav">
                            <span id="hd-indicator">HD</span>
                            <button id="cc-btn" aria-label="Legendas"><img alt="CC" src="assets/styles/images/player/closecaption-bottom.svg"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts do Projeto -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/lib/supabase-config.js"></script>
    <script src="js/components/loading-screen.js"></script>
    <script src="js/services/auth.js"></script>
    <script src="js/services/user.js"></script>
    <script src="js/components/identity-modal.js"></script>
    <script src="js/components/profile-widget.js"></script>
    <script src="js/app.js"></script>
    <script>

        document.getElementById('user-avatar').addEventListener('click', () => {
                window.ProfileWidget.open();
            });
        document.addEventListener('DOMContentLoaded', () => {
            // --- ESTADO DA APLICAÇÃO ---
            const state = {
                episodes: [ // Isso virá do Supabase
                    { id: 1, title: "Os primórdios", description: "Entendendo a evolução do cérebro...", duration: "32 min", episodeNumber: 1, image: "assets/styles/images/thumbnails/Rectangle 35.jpg", videoUrl: "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4", trackUrl: "https://raw.githubusercontent.com/andreybleme/legendas/main/big-buck-bunny/pt-br.vtt" },
                    { id: 2, title: "Obtendo a visão clara", description: "Entenda como criar uma visão clara...", duration: "35 min", episodeNumber: 2, image: "assets/styles/images/thumbnails/Rectangle 36.jpg", videoUrl: "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4", trackUrl: "" },
                    { id: 3, title: "Entendendo o vício", description: "Como o cérebro constroe um caminho neural...", duration: "42 min", episodeNumber: 3, image: "assets/styles/images/thumbnails/Rectangle 37.jpg", videoUrl: "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4", trackUrl: "" },
                    { id: 4, title: "A cirurgia na alma", description: "Saiba como fazer a cirurgia na alma...", duration: "49 min", episodeNumber: 4, image: "assets/styles/images/thumbnails/Rectangle 38.jpg", videoUrl: "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4", trackUrl: "" },
                ],
                userProgress: {}, // Ex: { 1: 50, 2: 100 } (episodeId: percentage)
                currentUser: null,
                currentPlayingEpisodeId: null,
                progressSaveInterval: null,
            };
    
            // --- ELEMENTOS DO DOM ---
            const episodesGrid = document.getElementById('episodes-grid');
            // Header elements
            const usernameEl = document.getElementById('welcome-username');
            const userAvatarEl = document.getElementById('user-avatar');
            const rankIconEl = document.getElementById('status-rank-icon');
            const progressDaysEl = document.getElementById('progress-days');
            const progressBarFillEl = document.getElementById('progress-bar-fill');
            // Player elements
            const playerOverlay = document.getElementById('player-overlay');
            const video = document.getElementById('video-player');
            const playerTitle = document.getElementById('player-episode-title');
            const videoContainer = document.getElementById('video-container');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playPauseIcon = document.getElementById('play-pause-icon');
            const playerProgressBarFill = document.getElementById('player-progress-bar-fill');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const closePlayerBtn = document.getElementById('close-player-btn');
            const pipBtn = document.getElementById('pip-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const skipBackwardBtn = document.getElementById('skip-backward-btn');
            const skipForwardBtn = document.getElementById('skip-forward-btn');
    
            // [FIX 1] Corrigindo os ícones de Play/Pause. O ícone de pause estava sem o prefixo data URI.
            // O ícone de play foi convertido para Base64 para ser mais robusto e não depender de um link externo.
            const playIconSrc = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjgiIHZpZXdCb3g9IjAgMCAyNCAyOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIzLjEwMTUgMTIuMTEzOEMyNC40MzgxIDEyLjg5MTggMjQuNDM4MSAxNC44ODU5IDIzLjEwMTUgMTUuNjY3OUwwLjkzODMzMSAyNy45Mzk0Qy0wLjQyNTI2OSAyOC43Mzk0IC0yLjEyNSAyNy43MTg0IC0yLjEyNSAyNi4wNjA4VjEuNzE3MDVDLTIuMTI1IDAuMDU1NDQ1IC0wLjQyNTI3IC0wLjk2MTU1NCAwLjkzODMzMSAwLjgyMjM0NkwyMy4xMDE1IDEyLjExMzhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K";
            const pauseIconSrc = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjkiIHZpZXdCb3g9IjAgMCAyNSAyOSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTggMEg0QzEuNzkgMCAwIDEuNzkgMCA0VjI1QzAgMjcuMjEgMS43OSAyOSA0IDI5SDhDMTAuMjEgMjkgMTIgMjcuMjEgMTIgMjVWNEMxMiAxLjc5IDEwLjIxIDAgOCAwWiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTIxIDBIMTdDMTQuNzkgMCAxMyAxLjc5IDEzIDRWMjVDMTMgMjcuMjEgMTQuNzkgMjkgMTcgMjlIMjFDMjMuMjEgMjkgMjUgMjcuMjEgMjUgMjVWNEMyNSAxLjc5IDIzLjIxIDAgMjEgMFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=";
            
            // --- FUNÇÕES DE RENDERIZAÇÃO E UI ---
            function renderHeader() {
                if (!state.currentUser) return;
                usernameEl.textContent = `Soldado ${state.currentUser.profile.last_name}`;
                userAvatarEl.src = state.currentUser.profile.avatar_url;
            }
    
            function renderEpisodes() {
                episodesGrid.innerHTML = '';
                state.episodes.forEach(episode => {
                    const progress = state.userProgress[episode.id] || 0;
                    const card = document.createElement('div');
                    card.className = `episode-card ${progress === 0 ? 'unwatched' : 'watched'}`;
                    card.dataset.episodeId = episode.id;
    
                    card.innerHTML = `
                        <h3>${episode.title}</h3>
                        <p>${episode.description}</p>
                        <div class="thumbnail-container">
                            <img src="${episode.image}" alt="Thumbnail para ${episode.title}">
                            <div class="episode-info-overlay">
                                <div class="episode-meta">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor"><path d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM256 464c-114.7 0-208-93.3-208-208S141.3 48 256 48s208 93.3 208 208S370.7 464 256 464zM328 272H256c-4.4 0-8-3.6-8-8V144c0-4.4 3.6-8 8-8s8 3.6 8 8v112h64c4.4 0 8 3.6 8 8s-3.6 8-8 8z"/></svg>
                                    <span>${episode.duration} • Episódio ${episode.episodeNumber}</span>
                                </div>
                                <div class="episode-progress-bar">
                                    <div class="episode-progress-fill" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    card.addEventListener('click', () => openPlayerForEpisode(episode.id));
                    episodesGrid.appendChild(card);
                });
            }
    
            // --- LÓGICA DO PLAYER ---
            function openPlayerForEpisode(episodeId) {
                const episode = state.episodes.find(ep => ep.id === episodeId);
                if (!episode) return;
    
                state.currentPlayingEpisodeId = episode.id;
                playerTitle.textContent = episode.title;
                
                video.querySelector('source').src = episode.videoUrl;
                const track = video.querySelector('track');
                track.src = episode.trackUrl || '';
                video.load();
    
                playerOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
    
                video.onloadedmetadata = () => {
                    const progress = state.userProgress[episodeId] || 0;
                    const startTime = (progress / 100) * video.duration;
                    video.currentTime = (startTime < video.duration - 2) ? startTime : 0;
                    video.play();
                    
                    clearInterval(state.progressSaveInterval);
                    state.progressSaveInterval = setInterval(saveCurrentProgress, 5000); // Salva a cada 5s
                };
            }
    
            function hidePlayer() {
                video.pause();
                playerOverlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
                
                clearInterval(state.progressSaveInterval);
                saveCurrentProgress(); // Salva uma última vez ao fechar
                state.currentPlayingEpisodeId = null;
            }
    
            function saveCurrentProgress() {
                if (!state.currentPlayingEpisodeId || isNaN(video.duration)) return;
                
                const episodeId = state.currentPlayingEpisodeId;
                const progressPercentage = (video.currentTime / video.duration) * 100;
                
                state.userProgress[episodeId] = progressPercentage > 95 ? 100 : progressPercentage;
                
                // TODO: Chamar `saveVideoProgress(episodeId, state.userProgress[episodeId])` do user.js
                console.log(`Salvando progresso do ep ${episodeId}: ${state.userProgress[episodeId]}%`);
            }
            
            // --- INICIALIZAÇÃO ---
            async function init() {
                try {
                    // Carrega os dados reais do usuário do Supabase
                    state.currentUser = await window.loadTopBar();
                    
                    // Busca o progresso dos vídeos do usuário
                    state.userProgress = await window.UserService.getVideoProgress();
                    
                    console.log('✅ Estado da aplicação inicializado:', state);
                } catch (error) {
                    console.error('❌ Erro ao inicializar aplicação:', error);
                    // Redireciona para login se houver erro
                    window.location.href = 'index.html';
                    return;
                }
    
                renderHeader();
                renderEpisodes();
                setupPlayerControls();
            }
    
            function setupPlayerControls() {
                let inactivityTimer; // [FIX 2.1] Variável para controlar o timer de inatividade
    
                const formatTime = (s) => (isNaN(s) ? "00:00" : new Date(s * 1000).toISOString().substr(14, 5));
                const togglePlay = () => video.paused ? video.play() : video.pause();
                
                const updatePlayPauseIcon = () => {
                    const isPaused = video.paused;
                    playPauseIcon.src = isPaused ? playIconSrc : pauseIconSrc;
                    videoContainer.classList.toggle('paused', isPaused);
                };
                
                const updateProgress = () => {
                    if (isNaN(video.duration)) return;
                    const progress = (video.currentTime / video.duration) * 100;
                    playerProgressBarFill.style.width = `${progress}%`;
                    currentTimeEl.textContent = formatTime(video.currentTime);
                    
                    const card = episodesGrid.querySelector(`.episode-card[data-episode-id="${state.currentPlayingEpisodeId}"] .episode-progress-fill`);
                    if (card) card.style.width = `${progress}%`;
                };
                
                // [FIX 2.2] Função para mostrar os controles e iniciar o timer para escondê-los
                const showControlsAndSetTimer = () => {
                    videoContainer.classList.add('user-active');
                    clearTimeout(inactivityTimer); // Reseta o timer anterior
    
                    // Se o vídeo não estiver pausado, define um novo timer para esconder os controles
                    if (!video.paused) {
                        inactivityTimer = setTimeout(() => {
                            videoContainer.classList.remove('user-active');
                        }, 3000); // Esconde após 3 segundos de inatividade
                    }
                };
    
                video.addEventListener('play', () => {
                    updatePlayPauseIcon();
                    showControlsAndSetTimer(); // Garante que o timer comece quando o vídeo tocar
                });
                video.addEventListener('pause', () => {
                    updatePlayPauseIcon();
                    clearTimeout(inactivityTimer); // Para o timer quando o vídeo é pausado
                    videoContainer.classList.add('user-active'); // Força a exibição dos controles no pause
                });
                video.addEventListener('timeupdate', updateProgress);
                video.addEventListener('loadedmetadata', () => {
                    durationEl.textContent = ` / ${formatTime(video.duration)}`;
                    showControlsAndSetTimer(); // Mostra os controles assim que o vídeo carregar
                });
                
                video.addEventListener('click', togglePlay);
                playPauseBtn.addEventListener('click', togglePlay);
                closePlayerBtn.addEventListener('click', hidePlayer);
                skipBackwardBtn.addEventListener('click', () => video.currentTime -= 10);
                skipForwardBtn.addEventListener('click', () => video.currentTime += 10);
    
                // [FIX 2.3] Adiciona o listener de movimento do mouse no container do vídeo
                videoContainer.addEventListener('mousemove', showControlsAndSetTimer);
                
                progressBarContainer.addEventListener('click', (e) => {
                    const rect = progressBarContainer.getBoundingClientRect();
                    video.currentTime = ((e.clientX - rect.left) / rect.width) * video.duration;
                });
    
                fullscreenBtn.addEventListener('click', () => {
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        // Usar o overlay para o fullscreen garante que os controles personalizados entrem em tela cheia também
                        playerOverlay.requestFullscreen();
                    }
                });
                pipBtn.addEventListener('click', () => {
                    if (document.pictureInPictureElement) {
                        document.exitPictureInPicture();
                    } else if (document.pictureInPictureEnabled) {
                        video.requestPictureInPicture();
                    }
                });
            }
    
            init();
        });
    </script>

</body>
</html>







