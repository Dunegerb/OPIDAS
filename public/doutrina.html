<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doutrina - OPIDAS</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="assets/styles/base.css">
    <!-- Link para os estilos do campo para reutilizar o top-bar -->
    <link rel="stylesheet" href="assets/styles/campo.css"> 
    <link rel="stylesheet" href="assets/styles/doutrina.css">
</head>
<body>

    <div class="app-container">
        <!-- Logo central para consistência visual -->
        <a href="doutrina.html"> 
            <img class="opidas-logo-center" alt="Opidas logo" src="assets/styles/images/opidaslogoouroboros.png" style="cursor: pointer;"> 
        </a>

        <!-- Header idêntico ao da página "campo.html" -->
        <header class="top-bar">
            <div class="user-welcome">
                <img id="user-avatar" alt="Profile photo" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/profile-card.png" />
                <div class="user-welcome-text">
                    <div class="greeting">Bem vindo(a) de volta</div>
                    <div class="username" id="welcome-username">Carregando...</div>
                </div>
            </div>

            <div class="status-bar">
                <div class="rank-icon" id="status-rank-icon-container">
                    <img id="status-rank-icon" alt="Patente" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/patentes/Recruta.png" />
                </div>
                <div class="progress-info">
                    <p class="days" id="progress-days">
                        00<span>/00 Dias</span>
                    </p>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progress-bar-fill"></div>
                    </div>
                </div>
                <button class="icon-button">
                    <img alt="Notificação button" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/notifica%C3%A7%C3%A3obutton.svg" />
                </button>
                <button class="icon-button" id="logout-button">
                    <img alt="Logout" src="https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/darkmode-button.svg" />
                </button>
            </div>
        </header>

        <!-- Conteúdo principal da Doutrina -->
        <main class="main-content-doutrina">
            <section class="episodes-section">
                <div class="timeline">
                    <div class="timeline-dots">
                        <div class="timeline-dot dot-1"></div>
                        <div class="timeline-dot dot-2"></div>
                        <div class="timeline-dot dot-3"></div>
                        <div class="timeline-dot dot-4"></div>
                    </div>
                </div>
                <div id="episodes-grid" class="episodes-grid">
                    <!-- Episódios são injetados aqui pelo JavaScript -->
                </div>
            </section>
        </main>
    </div>
    
    <!-- Player Overlay -->
    <div id="player-overlay" class="hidden">
        <div id="video-container" class="video-container paused">
            <video id="video-player" playsinline>
                <source src="" type="video/mp4">
                <track label="Português" kind="subtitles" srclang="pt" src="" default>
            </video>

            <div id="player-controls" class="player-controls">
                <header class="top-controls">
                    <h1 class="episode-title" id="player-episode-title">{nome do episódio}</h1>
                    <nav class="top-right-nav" aria-label="Controles do Vídeo">
                        <button id="pip-btn" aria-label="Picture in picture"><img alt="Picture in picture" src="https://c.animaapp.com/VdjJnM12/img/union-2.svg"></button>
                        <button id="fullscreen-btn" aria-label="Tela Cheia"><img alt="Tela Cheia" src="https://c.animaapp.com/VdjJnM12/img/vector-8.svg"></button>
                        <div class="separator" aria-hidden="true"></div>
                        <button id="close-player-btn" aria-label="Fechar Player"><img alt="Fechar Player" src="https://c.animaapp.com/VdjJnM12/img/vector-7.svg"></button>
                    </nav>
                </header>
                <div class="center-controls"><!-- ... (controles do player) ... --></div>
                <div class="bottom-controls"><!-- ... (controles do player) ... --></div>
            </div>
        </div>
    </div>

    <!-- Scripts do Projeto -->
    <script src="js/lib/supabase.js"></script>
    <script src="js/services/auth.js"></script>
    <script src="js/services/user.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ESTADO DA APLICAÇÃO ---
            const state = {
                // ... (estado de episódios e progresso) ...
                currentUser: null,
                channels: [ // Estrutura de patentes para popular o header
                    { id: 'recruta', level: 0, name: 'Recruta', minDays: 0, maxDays: 9, icon: 'assets/styles/images/patentes/Recruta.png' },
                    { id: 'soldado', level: 1, name: 'Soldado', minDays: 10, maxDays: 29, icon: 'assets/styles/images/patentes/Soldado.png' },
                    // ... (outras patentes)
                ]
            };

            // --- ELEMENTOS DO DOM (HEADER ATUALIZADO) ---
            const welcomeUsernameEl = document.getElementById('welcome-username');
            const userAvatarEl = document.getElementById('user-avatar');
            const statusRankIconEl = document.getElementById('status-rank-icon');
            const progressDaysEl = document.getElementById('progress-days');
            const progressBarFillEl = document.getElementById('progress-bar-fill');
            const logoutButton = document.getElementById('logout-button');
            
            // --- ELEMENTOS DO DOM (PÁGINA DOUTRINA) ---
            const episodesGrid = document.getElementById('episodes-grid');
            // ... (elementos do player) ...

            // --- FUNÇÕES DE RENDERIZAÇÃO E UI ---
            function updateUI() {
                if (!state.currentUser) return;
                
                const { profile, rankData } = state.currentUser;

                // Header
                welcomeUsernameEl.textContent = `${rankData.name} ${profile.last_name}`;
                userAvatarEl.src = profile.avatar_url || 'https://github.com/Dunegerb/OPIDAS/raw/ba479afa9718cc1bd2b6a3d4e75d7b1bbe0da0f4/public/assets/styles/images/profile-card.png';
                statusRankIconEl.src = rankData.icon;
                
                // Barra de Progresso (exemplo, ajuste a lógica conforme necessário)
                const rankGoalDays = isFinite(rankData.maxDays) ? rankData.maxDays + 1 : profile.retention_days;
                const progressPercentage = (profile.retention_days / rankGoalDays) * 100;
                progressBarFillEl.style.width = `${progressPercentage}%`;
                progressDaysEl.innerHTML = `${String(profile.retention_days).padStart(2, '0')}<span>/${String(rankGoalDays).padStart(2, '0')} Dias</span>`;
            }

            function renderEpisodes() { /* ... (código existente) ... */ }

            // --- LÓGICA DO PLAYER ---
            /* ... (código existente do player) ... */

            // --- INICIALIZAÇÃO ---
            async function init() {
                // TODO: protectRoute();

                // Mock de dados do usuário, inclua rank e retention_days
                state.currentUser = {
                    profile: {
                        last_name: 'Stravelli',
                        avatar_url: 'https://c.animaapp.com/dWBnxj7P/img/profile-photo@2x.png',
                        retention_days: 15,
                        rank: 'soldado' // Patente atual do usuário
                    },
                    rankData: null // Será preenchido abaixo
                };
                // Encontra os dados da patente com base no perfil do usuário
                state.currentUser.rankData = state.channels.find(c => c.id === state.currentUser.profile.rank);


                // TODO: Chamar `getVideoProgress()` do user.js
                state.userProgress = { 1: 75, 3: 100 }; // Mock

                updateUI(); // Atualiza o novo header
                renderEpisodes();
                //setupPlayerControls(); // Função do player
                
                logoutButton.addEventListener('click', () => {
                    // TODO: Chamar signOut() de auth.js
                    console.log("Logout...");
                    window.location.href = 'index.html';
                });
            }

            init();
        });
    </script>

</body>
</html>
