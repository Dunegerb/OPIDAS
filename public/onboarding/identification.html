<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onboarding: Identifica√ß√£o - OPIDAS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/identification.css">
</head>
<body>
    <header class="page-header">
        <img alt="OPIDAS Brand Logos" src="/assets/styles/images/logoopidas+campo.svg">
    </header>

    <div class="onboarding-card">
        <img class="background-image-left" alt="" src="/assets/styles/images/backgroundcardsecin.png">
        
        <main class="main-content">
            <!-- Se√ß√£o do Cart√£o de Identidade (Preview Fixo ) -->
            <section class="identity-card-section" aria-label="Identity Card Preview">
                <div class="card-base"></div><img class="card-texture" alt="" src="/assets/styles/images/texturecard.png"><img class="card-logo-overlay" alt="Opidas logo" src="/assets/styles/images/logomarkcard.png"><div class="card-background-mark"><img alt="" src="/assets/styles/images/mark-card.png"></div><img class="card-vector-top1" alt="" src="/assets/styles/images/vectorcardtop1.svg"><img class="card-vector-top2" alt="" src="/assets/styles/images/identidadedocampobackground.png"><h1 class="card-title">IDENTIDADE DO CAMPO</h1><img class="card-logo-top-right" alt="" src="/assets/styles/images/logosopidas+campo-card.png"><img id="cardProfilePhoto" class="card-profile-photo" alt="Profile photo" src="/assets/styles/images/profile-card.png"><div class="card-field contra"><span class="label">Contra:</span><span id="cardContra" class="value">PORNOGRAFIA</span></div><div class="card-field signature"><span class="label">Assinatura:</span><span id="cardSignature" class="value"></span></div><h2 class="card-data-heading">DADOS:</h2><div class="card-field registration"><span class="label">N.¬∫ de registro:</span><span id="cardRegistration" class="value">M0RSI-00000000</span></div><div class="card-field warrior-name"><span class="label">Nome do Guerreiro(a):</span><span id="cardWarriorName" class="value"></span></div><div class="card-field rank"><span class="label">Patente:</span><span id="cardRank" class="value"></span></div><div class="card-field enlistment"><span class="label">Data de Alistamento:</span><span class="value"><span id="cardDay" class="date-part">16</span> /<span id="cardMonth" class="date-part">DEZ</span> /<span id="cardYear" class="date-part">2025</span></span></div>
            </section>

            <!-- Cont√™iner para a Etapa do Formul√°rio -->
            <div class="form-steps-container">
                <section class="form-step user-identification-section">
                    <div class="opidas-logo"><img alt="OPIDAS logo" src="/assets/styles/images/opidaslogomini.png"><span>OPIDAS</span></div>
                    <h1 class="form-title">Sua identifica√ß√£o</h1>
                    <p class="form-subtitle">Coloque todos seus dados para criar sua identifica√ß√£o para o campo.</p>
                    <div class="form-row"><div class="input-group"><input id="firstNameInput" type="text" placeholder="Primeiro Nome" class="input-field"></div><div class="input-group"><input id="lastNameInput" type="text" placeholder="Sobrenome" class="input-field"></div></div>
                    <div class="dropdown-container"><button type="button" id="dropdownButton" class="dropdown-button" aria-haspopup="listbox" aria-expanded="false"><span id="dropdownLabel" class="placeholder">Contra o h√°bito</span><img alt="Dropdown arrow" src="/assets/styles/images/arrowdown.svg"></button><ul id="dropdownMenu" class="dropdown-menu" role="listbox"></ul></div>
                    <div class="file-upload-area"><input type="file" id="file-upload" class="hidden-file-input" accept=".png,.jpg,.jpeg,.webp"><label for="file-upload" id="drop-zone" class="drop-zone"><img alt="Upload icon" src="/assets/styles/images/uploadicon.svg"><span class="drop-text">Arraste e solte</span><p class="drop-info">(PNG, JPG, WEBP) Max 5MB</p></label><label for="file-upload" class="file-label">Escolha o arquivo</label><p id="file-name-display"></p></div>
                    <div class="form-actions"><button id="btnGoToNextStep" class="btn btn-primary"><span>Avan√ßar</span><img alt="" src="/assets/styles/images/decorative-element-button.png"></button></div>
                </section>
            </div>
        </main>
    </div>

    <!-- Scripts do Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/lib/supabase-config.js"></script>
    <script src="../js/services/user.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', ( ) => {
            // --- Estado e Constantes da P√°gina ---
            const habits = [ { id: "masturbacao", label: "Masturba√ß√£o" }, { id: "pornografia", label: "Pornografia" }, { id: "fumar", label: "Fumar" }, { id: "bebida", label: "Bebida Alc√≥lica" }, { id: "outro", label: "Outro" }, ];
            const monthNames = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];
            let userData = {
                firstName: '',
                lastName: '',
                habit: null,
                profilePhotoUrl: null,
                enlistmentDate: new Date().toISOString()
            };

            // --- Seletores de Elementos DOM ---
            const firstNameInput = document.getElementById('firstNameInput');
            const lastNameInput = document.getElementById('lastNameInput');
            const dropdownButton = document.getElementById('dropdownButton');
            const dropdownLabel = document.getElementById('dropdownLabel');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-upload');
            const fileNameDisplay = document.getElementById('file-name-display');
            const cardWarriorName = document.getElementById('cardWarriorName');
            const cardContra = document.getElementById('cardContra');
            const cardProfilePhoto = document.getElementById('cardProfilePhoto');
            const cardRegistration = document.getElementById('cardRegistration');
            const cardSignature = document.getElementById('cardSignature');
            const cardDay = document.getElementById('cardDay');
            const cardMonth = document.getElementById('cardMonth');
            const cardYear = document.getElementById('cardYear');
            const btnGoToNextStep = document.getElementById('btnGoToNextStep');

            // --- Fun√ß√µes de Atualiza√ß√£o da UI ---
            const updateCardName = () => {
                userData.firstName = firstNameInput.value.trim();
                userData.lastName = lastNameInput.value.trim();
                cardWarriorName.textContent = `${userData.firstName} ${userData.lastName}`.toUpperCase().trim();
                cardSignature.textContent = userData.lastName.toUpperCase().trim();
            };
            const updateCardContra = () => { cardContra.textContent = userData.habit ? userData.habit.label.toUpperCase() : ''; };
            const updateCardPhoto = (file) => {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        userData.profilePhotoUrl = e.target.result;
                        cardProfilePhoto.src = userData.profilePhotoUrl;
                    };
                    reader.readAsDataURL(file);
                }
            };
            const setEnlistmentDate = (date) => {
                cardDay.textContent = date.getDate().toString().padStart(2, '0');
                cardMonth.textContent = monthNames[date.getMonth()];
                cardYear.textContent = date.getFullYear();
            };

            // --- L√≥gica de Carregamento e Persist√™ncia ---
            const saveState = () => {
                localStorage.setItem('onboardingData', JSON.stringify(userData));
            };

            const loadState = async () => {
                // ‚ö†Ô∏è CORRE√á√ÉO: Limpar o localStorage se o usu√°rio j√° tiver completado o onboarding
                // ou se a sess√£o for nova para evitar dados de teste persistentes.
                const { data: { session } } = await window.supabase.auth.getSession();
                
                if (!session) {
                    // Se n√£o h√° sess√£o, √© um novo usu√°rio, limpa qualquer lixo de teste
                    localStorage.removeItem('onboardingData');
                }

                const savedData = localStorage.getItem('onboardingData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    userData = { ...userData, ...parsedData };
                    
                    firstNameInput.value = userData.firstName || '';
                    lastNameInput.value = userData.lastName || '';
                    if (userData.habit) {
                        // Encontra o objeto completo do h√°bito para garantir que o label est√° correto
                        const habitObject = habits.find(h => h.id === userData.habit.id);
                        if (habitObject) {
                            userData.habit = habitObject; // Atualiza o objeto completo
                            dropdownLabel.textContent = habitObject.label;
                            dropdownLabel.classList.remove('placeholder');
                        }
                    }
                    if (userData.profilePhotoUrl) {
                        cardProfilePhoto.src = userData.profilePhotoUrl;
                    }
                    updateCardName();
                    updateCardContra();
                }
            };

            // --- L√≥gica de Eventos ---
            firstNameInput.addEventListener('input', updateCardName);
            lastNameInput.addEventListener('input', updateCardName);
            
            const populateDropdown = () => {
                habits.forEach(habit => {
                    const li = document.createElement('li');
                    li.className = 'dropdown-item';
                    li.setAttribute('role', 'option');
                    li.innerHTML = `<div class="checkbox-custom"><div class="checkbox-inner"></div></div><span>${habit.label}</span>`;
                    
                    if (userData.habit && userData.habit.id === habit.id) {
                        li.querySelector('.checkbox-custom').classList.add('selected');
                    }
                    
                    li.addEventListener('click', () => {
                        userData.habit = habit;
                        dropdownLabel.textContent = habit.label;
                        dropdownLabel.classList.remove('placeholder');
                        document.querySelectorAll('.dropdown-item .checkbox-custom').forEach(el => el.classList.remove('selected'));
                        li.querySelector('.checkbox-custom').classList.add('selected');
                        dropdownMenu.classList.remove('open');
                        dropdownButton.setAttribute('aria-expanded', 'false');
                        updateCardContra();
                    });
                    dropdownMenu.appendChild(li);
                });
            };

            dropdownButton.addEventListener('click', () => {
                dropdownMenu.classList.toggle('open');
                dropdownButton.setAttribute('aria-expanded', dropdownMenu.classList.contains('open'));
            });
            document.addEventListener('click', (e) => {
                if (!dropdownButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.remove('open');
                    dropdownButton.setAttribute('aria-expanded', 'false');
                }
            });

            const handleFile = (file) => {
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { return alert('O arquivo √© muito grande (Max 5MB).'); }
                    if (!['image/png', 'image/jpeg', 'image/webp'].includes(file.type)) { return alert('Formato inv√°lido.'); }
                    fileNameDisplay.textContent = `Arquivo: ${file.name}`;
                    updateCardPhoto(file);
                }
            };
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--accent-color)'; });
            dropZone.addEventListener('dragleave', () => dropZone.style.borderColor = 'var(--border-color)');
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--border-color)'; handleFile(e.dataTransfer.files[0]); });
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            
            btnGoToNextStep.addEventListener('click', async () => {
                if (!userData.firstName || !userData.lastName || !userData.habit || !userData.profilePhotoUrl) {
                    alert('Por favor, preencha todos os campos e envie uma foto.');
                    return;
                }
                
                try {
                    console.log('üìù Salvando dados da Etapa 1...');
                    
                    // Salva no localStorage
                    saveState();
                    
                    // Salva no Supabase (usando 'habit' conforme schema do banco)
                    await window.UserService.updateUserProfile({
                        first_name: userData.firstName,
                        last_name: userData.lastName,
                        avatar_url: userData.profilePhotoUrl,
                        habit: userData.habit.id  // ‚úÖ CORRIGIDO: usa 'habit' em vez de 'habit_id'
                    });
                    
                    console.log('‚úÖ Dados da Etapa 1 salvos com sucesso');
                    window.location.href = 'investment.html';
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar dados:', error);
                    alert('Erro ao salvar dados. Tente novamente.');
                }
            });
            
            // --- Inicializa√ß√£o ---
            const initialize = async () => {
                await loadState(); // Agora √© ass√≠ncrono
                cardRegistration.textContent = "M0RSI-00000000";
                populateDropdown();
                setEnlistmentDate(new Date(userData.enlistmentDate));
            };
            initialize();
        });
    </script>
</body>
</html>
